name: Rotate Daily Quiz Files

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Daily at 00:00 UTC (03:00 Turkey)

permissions:
  contents: write

concurrency:
  group: rotate-quiz-files
  cancel-in-progress: false

env:
  CATEGORIES: "AWS Linux Docker"

jobs:
  rotate-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check if system is enabled
        id: config
        run: |
          ENABLED=$(jq -r '.enabled' config.json)
          echo "enabled=$ENABLED" >> $GITHUB_OUTPUT
          if [ "$ENABLED" != "true" ]; then
            echo "System is disabled via config.json. Skipping."
          fi

      - name: Select random quiz from each category
        if: steps.config.outputs.enabled == 'true'
        run: |
          MISSING_CATEGORIES=""
          SELECTED_COUNT=0

          for CATEGORY in ${{ env.CATEGORIES }}; do
            echo "=== Processing category: $CATEGORY ==="

            # Ensure directories exist
            mkdir -p "01-db/$CATEGORY" "02-today/$CATEGORY" "03-sent/$CATEGORY"

            # Find all images in the category's db folder
            IMAGES=$(find "01-db/$CATEGORY" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) 2>/dev/null)

            if [ -z "$IMAGES" ]; then
              echo "::warning::No images found in 01-db/$CATEGORY"
              MISSING_CATEGORIES="$MISSING_CATEGORIES $CATEGORY"
              continue
            fi

            # Count available images
            IMAGE_COUNT=$(echo "$IMAGES" | wc -l | tr -d ' ')
            echo "Found $IMAGE_COUNT images in $CATEGORY"

            # Select a random image using shuf
            RANDOM_IMAGE=$(echo "$IMAGES" | shuf -n 1)
            IMAGE_NAME=$(basename "$RANDOM_IMAGE")
            BASE_NAME="${IMAGE_NAME%.*}"
            echo "Selected: $RANDOM_IMAGE"

            # Move image to today's folder
            mv "$RANDOM_IMAGE" "02-today/$CATEGORY/"
            echo "Moved image to 02-today/$CATEGORY/"

            # Also move the answer file if it exists (same name but .txt or .md)
            DIR_NAME=$(dirname "$RANDOM_IMAGE")
            for ext in txt md; do
              ANSWER_FILE="${DIR_NAME}/${BASE_NAME}.${ext}"
              if [ -f "$ANSWER_FILE" ]; then
                mv "$ANSWER_FILE" "02-today/$CATEGORY/"
                echo "Moved answer file: ${BASE_NAME}.${ext}"
                break
              fi
            done

            SELECTED_COUNT=$((SELECTED_COUNT + 1))
          done

          echo ""
          echo "=== Summary ==="
          echo "Selected $SELECTED_COUNT quizzes for tomorrow"

          if [ -n "$MISSING_CATEGORIES" ]; then
            echo "::warning::Missing images for:$MISSING_CATEGORIES"
            echo ""
            echo "Please add more quiz images to the following folders:"
            for CAT in $MISSING_CATEGORIES; do
              echo "  - 01-db/$CAT/"
            done
          fi

          if [ $SELECTED_COUNT -eq 0 ]; then
            echo "::error::No quizzes selected! All categories are empty."
            echo "Please add quiz images to 01-db/{AWS,Linux,Docker}/ folders"
            exit 1
          fi

      - name: Commit and push changes
        if: steps.config.outputs.enabled == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add 01-db 02-today
          git diff --staged --quiet || git commit -m "Rotate daily quiz files"
          git push
