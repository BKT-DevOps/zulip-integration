name: Send Daily Quiz Image to Zulip

on:
  workflow_dispatch:  # Allows manual triggering
  schedule:
    - cron: '0 9 * * *'  # Runs daily at 9 AM UTC

jobs:
  send-image:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Find image in 02-today folder
        id: find-image
        run: |
          IMAGE=$(find 02-today -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) | sort | head -n 1)
          if [ -z "$IMAGE" ]; then
            echo "No images found in 02-today folder"
            exit 1
          fi
          echo "image_path=$IMAGE" >> $GITHUB_OUTPUT
          echo "Found image: $IMAGE"
      
      - name: Get image URL from GitHub
        run: |
          IMAGE_PATH="${{ steps.find-image.outputs.image_path }}"
          IMAGE_NAME=$(basename "$IMAGE_PATH")
          # Use 03-sent path since the file will be moved there at midnight
          IMAGE_URL="https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/03-sent/$IMAGE_NAME"
          echo "image_url=$IMAGE_URL" >> $GITHUB_ENV
          echo "image_name=$IMAGE_NAME" >> $GITHUB_ENV
          echo "Image URL: $IMAGE_URL"
      
      - name: Send message with image to Zulip
        run: |
          curl -s -X POST ${{ secrets.ZULIP_SITE }}/api/v1/messages \
            -u ${{ secrets.ZULIP_BOT_EMAIL }}:${{ secrets.ZULIP_API_KEY }} \
            -d "type=stream" \
            -d "to=553174" \
            -d "topic=Daily Quiz" \
            -d "content=ðŸ“¸ Daily Quiz Image%0A![${{ env.image_name }}](${{ env.image_url }})"
